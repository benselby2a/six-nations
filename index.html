<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Six Nations Predictor</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@400;600;800&family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Six Nations</h1>
            <div class="subtitle">Prediction Challenge 2026</div>
        </header>

        <!-- Login View -->
        <div id="loginView">
            <div class="login-section">
                <h2>Join The Game</h2>
                <div id="loginFeedback" class="login-feedback hidden"></div>

                <!-- Guest Login -->
                <button class="guest-login-btn" onclick="loginAsGuest()">View Scores as Guest</button>
                <div class="guest-login-divider">
                    <span>or</span>
                </div>
                
                <!-- Toggle buttons -->
                <div class="login-toggle">
                    <button class="toggle-btn active" onclick="showLoginForm('existing')">Existing Competitor</button>
                    <!--<button class="toggle-btn" onclick="showLoginForm('new')">New Competitor</button> -->
                </div>

                <!-- Existing User Form -->
                <div id="existingUserForm" class="login-form">
                    <div class="input-group">
                        <label for="existingUsername">Username</label>
                        <input type="text" id="existingUsername" placeholder="Enter your username" onkeypress="handleLoginKeyPress(event, 'existing')">
                    </div>
                    <div class="input-group">
                        <label for="existingPassword">Password</label>
                        <input type="password" id="existingPassword" placeholder="Enter password" onkeypress="handleLoginKeyPress(event, 'existing')">
                    </div>
                    <button onclick="loginExisting()">Login</button>
                </div>

                <!-- New User Form
                <div id="newUserForm" class="login-form hidden">
                    <div class="input-group">
                        <label for="newUsername">Username</label>
                        <input type="text" id="newUsername" placeholder="Choose a username" onkeypress="handleLoginKeyPress(event, 'new')">
                    </div>
                    <div class="input-group">
                        <label for="nickname">Display Name</label>
                        <input type="text" id="nickname" placeholder="How you'll appear on the leaderboard" onkeypress="handleLoginKeyPress(event, 'new')">
                    </div>
                    <div class="input-group">
                        <label for="newPassword">Password</label>
                        <input type="password" id="newPassword" placeholder="Create a password" onkeypress="handleLoginKeyPress(event, 'new')">
                    </div>
                    <div class="input-group">
                        <label>Supported Teams (up to 2)</label>
                        <div class="team-flags-picker" id="registerTeamsPicker"></div>
                    </div>
                    <button onclick="registerNewUser()">Create Account</button>
                </div> -->
            </div>
        </div>

        <!-- Profile Modal -->
        <div id="profileModal" class="modal hidden">
            <div class="modal-content">
                <h2 style="font-family: 'Bebas Neue', cursive; font-size: 2rem; color: var(--bright-gold); margin-bottom: 1.5rem; letter-spacing: 0.1em;">Profile Settings</h2>
                <div class="profile-save-reminder hidden" id="profileSaveReminder" style="display: none;">Remember to click Save Changes to apply any updates.</div>

                <div class="input-group">
                    <label for="profileUsername">Username</label>
                    <input type="text" id="profileUsername" readonly style="opacity: 0.6; cursor: default;">
                    <span class="profile-hint">This is what you use to log in.</span>
                </div>

                <div class="input-group">
                    <label for="profileDisplayName">Display Name</label>
                    <input type="text" id="profileDisplayName" placeholder="Your display name">
                    <span class="profile-hint">How your name appears on the leaderboard.</span>
                </div>

                <div class="input-group">
                    <label>Supported Teams (up to 2)</label>
                    <div class="team-flags-picker" id="profileTeamsPicker"></div>
                    <span class="profile-hint">Optionally show which team(s) you're supporting in the competition.</span>
                </div>

                <div class="profile-divider"></div>

                <div class="input-group">
                    <label>Change Password</label>
                    <span class="profile-hint" id="profilePasswordHint" style="margin-bottom: 0.5rem;">Leave blank to keep your current password.</span>
                </div>
                <div class="input-group">
                    <label for="profileCurrentPassword">Current Password</label>
                    <input type="password" id="profileCurrentPassword" placeholder="Enter current password" autocomplete="off">
                </div>
                <div class="input-group">
                    <label for="profileNewPassword">New Password</label>
                    <input type="password" id="profileNewPassword" placeholder="Enter new password" autocomplete="new-password">
                </div>
                <div class="input-group">
                    <label for="profileConfirmPassword">Confirm New Password</label>
                    <input type="password" id="profileConfirmPassword" placeholder="Confirm new password" autocomplete="new-password">
                </div>

                <div id="profileFeedback" class="login-feedback hidden"></div>
                <button onclick="saveProfile()">Save Changes</button>
                <button class="btn-cancel" onclick="closeProfile()">Cancel</button>
            </div>
        </div>

        <!-- Main App View -->
        <div id="appView" class="hidden">
            <div class="app-header">
                <div class="theme-selector">
                    <label for="themeSelect">Theme:</label>
                    <select id="themeSelect" onchange="changeTheme(this.value)">
                        <option value="classic">Classic</option>
                        <option value="retro">Teletext</option>
                        <option value="dark">Dark Mode</option>
                    </select>
                </div>
                <div class="user-info">
                    <div class="username profile-link" id="currentUser" onclick="openProfile()"></div>
                    <button class="logout-btn" id="logoutBtn" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab" onclick="showTab('predictions')">My Predictions</button>
                <button class="tab active" onclick="showTab('summary')">Match Summary</button>
            </div>
            
            <div class="admin-tabs-section admin-only hidden">
                <div class="admin-tabs-label">Admin Functions</div>
                <div class="tabs admin-tabs">
                    <button class="tab" onclick="showTab('competitors')">Competitor Management</button>
                    <button class="tab" onclick="showTab('results')">Fixture Setup</button>
                    <button class="tab" onclick="showTab('recovery')">Database Recovery</button>
                </div>
            </div>

            <!-- Predictions Tab -->
            <div id="predictionsTab" class="prediction-section hidden" style="margin-top: 2rem;">
                <div id="matchesContainer"></div>

                <div class="tries-section" id="triesSection">
                    <h3>Total Tournament Tries</h3>
                    <p style="margin-bottom: 0.75rem; font-size: 0.95rem; opacity: 0.8;">Predict the total tries scored across all matches.</p>
                    <input type="number" class="tries-input" id="totalTries" min="0" placeholder="000">
                </div>
            </div>

            <!-- Summary Tab -->
            <div id="summaryTab" style="margin-top: 2rem;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 10px; border: 2px solid var(--gold); margin-bottom: 2rem;">
                    <h2 style="font-family: 'Bebas Neue', cursive; font-size: 2.5rem; color: var(--bright-gold); margin-bottom: 1rem; letter-spacing: 0.1em;">Match Summary</h2>

                    <!-- Filters -->
                    <div class="summary-filters">
                        <button class="filter-btn active" onclick="filterMatches('all')">All Matches</button>
                        <button class="filter-btn" onclick="filterMatches('completed')">Completed Only</button>
                        <div class="round-filter-group">
                            <button class="filter-btn" onclick="filterMatches('round')">Filter By Round</button>
                            <span class="round-divider"></span>
                            <select id="roundSelect" class="round-select" onchange="onRoundSelectChange()">
                            </select>
                        </div>
                        <button class="export-btn" onclick="exportToPDF()" title="Export to PDF">
                            <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 7V3.5L18.5 9H13zM6 20V4h6v6h6v10H6z"/></svg>
                            Export
                        </button>
                    </div>
                </div>

                <div id="summaryContainer"></div>

                <!-- Stats and Tips at bottom -->
                <div style="margin-top: 3rem;">
                    <!-- Estimated Tries Stats -->
                    <div id="triesStatsContainer" class="tries-stats-box"></div>

                    <!-- Trev's Tips -->
                    <div id="trevsTipsContainer" class="trevs-tips-box"></div>
                </div>
            </div>

            <!-- All Predictions Tab -->
            <div id="allPredictionsTab" class="predictions-grid hidden">
                <div id="allPredictionsContainer"></div>
            </div>

            <!-- Competitor Management Tab (Admin Only) -->
            <div id="competitorsTab" class="prediction-section hidden" style="margin-top: 2rem;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 10px; border: 2px solid var(--gold); margin-bottom: 2rem;">
                    <h2 style="font-family: 'Bebas Neue', cursive; font-size: 2rem; color: var(--bright-gold); margin-bottom: 1rem; letter-spacing: 0.1em;">Competitor Management</h2>
                    <p style="margin-bottom: 1rem;">Manage competitor accounts - edit details or remove users.</p>
                </div>

                <div id="competitorManagementContainer"></div>
            </div>

            <!-- Fixture Setup Tab (Admin Only) -->
            <div id="resultsTab" class="prediction-section hidden" style="margin-top: 2rem;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 10px; border: 2px solid var(--gold); margin-bottom: 2rem;">
                    <h2 style="font-family: 'Bebas Neue', cursive; font-size: 2rem; color: var(--bright-gold); margin-bottom: 1rem; letter-spacing: 0.1em;">Fixture Setup</h2>
                    <p style="margin-bottom: 1rem;">Manage fixtures and results. Click a row or Edit to update all fixture fields.</p>
                </div>

                <!-- Lock Predictions Toggle -->
                <div class="lock-toggle">
                    <label>
                        <strong style="color: var(--gold);">LOCK PREDICTIONS</strong>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.3rem;">When enabled, competitors cannot change their predictions.</p>
                    </label>
                    <div id="lockToggle" class="toggle-switch" onclick="togglePredictionsLock()"></div>
                </div>

                <div class="results-table-container">
                    <table class="results-table" id="adminMatchesTable">
                        <thead>
                            <tr>
                                <th>Rnd</th>
                                <th>Fixture</th>
                                <th>Date/Time</th>
                                <th>Score</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminMatchesContainer"></tbody>
                    </table>
                </div>
                
                <div style="margin-top: 1.5rem; text-align: center; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="btn-small btn-success" onclick="addNewMatch()" style="padding: 0.75rem 2rem;">+ Add New Fixture</button>
                    <button class="btn-small" onclick="showBulkImport()" style="padding: 0.75rem 2rem; background: var(--accent-blue);">Bulk Import</button>
                    <button class="btn-small btn-danger" onclick="clearAllFixtures()" style="padding: 0.75rem 2rem;">Clear All Fixtures</button>
                </div>

                <!-- Bulk Import Modal -->
                <div id="bulkImportModal" class="modal hidden">
                    <div class="modal-content" style="max-width: 600px;">
                        <h2 style="font-family: 'Bebas Neue', cursive; font-size: 2rem; color: var(--bright-gold); margin-bottom: 1rem; letter-spacing: 0.1em;">Bulk Import Fixtures</h2>
                        <p style="margin-bottom: 1rem;">Enter one fixture per line in the format:</p>
                        <p style="margin-bottom: 1rem; font-family: monospace; background: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 5px;">Round, DD/MM/YYYY, HH:MM, Home Team, Away Team</p>
                        <p style="margin-bottom: 1rem; font-size: 0.9rem; opacity: 0.8;">Example:<br>
                        <span style="font-family: monospace;">1, 01/02/2026, 14:30, England, France</span><br>
                        <span style="font-family: monospace;">1, 01/02/2026, 17:00, Ireland, Wales</span><br>
                        <span style="font-family: monospace;">2, 08/02/2026, 14:30, France, Ireland</span></p>
                        <textarea id="bulkImportData" rows="10" style="width: 100%; padding: 1rem; background: rgba(255,255,255,0.1); border: 2px solid rgba(212,175,55,0.3); color: var(--white); font-family: monospace; font-size: 0.9rem; border-radius: 5px; resize: vertical;" placeholder="1, 01/02/2026, 14:30, England, France&#10;1, 01/02/2026, 17:00, Ireland, Wales&#10;2, 08/02/2026, 14:30, France, Ireland"></textarea>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: flex-end;">
                            <button class="btn-cancel" onclick="closeBulkImport()">Cancel</button>
                            <button onclick="processBulkImport()">Import Fixtures</button>
                        </div>
                    </div>
                </div>

                <!-- Edit Fixture Modal -->
                <div id="editFixtureModal" class="modal hidden">
                    <div class="modal-content" style="max-width: 760px;">
                        <h2 style="font-family: 'Bebas Neue', cursive; font-size: 2rem; color: var(--bright-gold); margin-bottom: 1rem; letter-spacing: 0.1em;">Edit Fixture</h2>
                        <div class="fixture-edit-grid">
                            <div class="input-group">
                                <label for="edit-fixture-round">Round</label>
                                <input type="number" id="edit-fixture-round" min="1" max="10">
                            </div>
                            <div class="input-group">
                                <label for="edit-fixture-date">Date</label>
                                <input type="date" id="edit-fixture-date">
                            </div>
                            <div class="input-group">
                                <label for="edit-fixture-time">Time</label>
                                <input type="time" id="edit-fixture-time">
                            </div>
                            <div class="input-group">
                                <label for="edit-fixture-team1">Home Team</label>
                                <select id="edit-fixture-team1"></select>
                            </div>
                            <div class="input-group">
                                <label for="edit-fixture-score1">Home Score</label>
                                <input type="number" id="edit-fixture-score1" min="0" placeholder="-">
                            </div>
                            <div class="input-group">
                                <label for="edit-fixture-tries1">Home Tries</label>
                                <input type="number" id="edit-fixture-tries1" min="0" placeholder="-">
                            </div>
                            <div class="input-group">
                                <label for="edit-fixture-team2">Away Team</label>
                                <select id="edit-fixture-team2"></select>
                            </div>
                            <div class="input-group">
                                <label for="edit-fixture-score2">Away Score</label>
                                <input type="number" id="edit-fixture-score2" min="0" placeholder="-">
                            </div>
                            <div class="input-group">
                                <label for="edit-fixture-tries2">Away Tries</label>
                                <input type="number" id="edit-fixture-tries2" min="0" placeholder="-">
                            </div>
                            <div class="input-group" style="display: flex; align-items: center; gap: 0.6rem;">
                                <input type="checkbox" id="edit-fixture-joker">
                                <label for="edit-fixture-joker" style="margin: 0;">Joker Eligible</label>
                            </div>
                        </div>
                        <div class="fixture-modal-actions">
                            <button class="btn-cancel" onclick="closeEditFixtureModal()">Cancel</button>
                            <button onclick="saveFixtureEdits()">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Recovery Tab (Admin Only) -->
            <div id="recoveryTab" class="prediction-section hidden" style="margin-top: 4rem;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 10px; border: 2px solid var(--gold); margin-bottom: 2rem;">
                    <h2 style="font-family: 'Bebas Neue', cursive; font-size: 2rem; color: var(--bright-gold); margin-bottom: 1rem; letter-spacing: 0.1em;">Database Recovery</h2>
                    <p style="margin-bottom: 1rem;">Copy the SQL below and run it in your Supabase SQL Editor to recreate the database with all current data.</p>
                </div>

                <div class="recovery-section">
                    <div class="recovery-card">
                        <h3>Database SQL Export</h3>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="includeDataCheckbox" checked onchange="updateRecoverySQL()" style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Include current data (users, predictions, settings)</span>
                            </label>
                        </div>
                        <p id="recoveryDescription">This SQL will recreate all tables and restore:</p>
                        <ul id="recoveryList" style="margin: 0.5rem 0 1rem 1.5rem; line-height: 1.6;">
                            <li>All matches and fixtures</li>
                            <li>All user accounts (usernames, password hashes)</li>
                            <li>All predictions</li>
                            <li>Admin usernames list</li>
                            <li>App settings</li>
                        </ul>
                        <pre class="sql-preview" id="sqlPreview"></pre>
                        <button class="btn-small" onclick="copySqlToClipboard()" style="margin-top: 1rem;">Copy SQL to Clipboard</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="app.js"></script>
</body>
</html>
